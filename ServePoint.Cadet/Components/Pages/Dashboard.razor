@page "/"
@page "/dashboard"
@rendermode InteractiveServer

@using System.Security.Claims
@using ServePoint.Cadet.Services
@using ServePoint.Cadet.Models.Entities
@using Microsoft.AspNetCore.Authorization

@attribute [Authorize]

@inject OpportunityService OpportunityService
@inject DashboardService DashboardService
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IConfiguration Config

<PageTitle>Dashboard</PageTitle>

<h1>Dashboard</h1>

@if (!string.IsNullOrWhiteSpace(m_Error))
{
    <div class="alert alert-danger">@m_Error</div>
}

@if (m_Data is null)
{
    <p>Loading…</p>
}
else
{
    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <div class="card sp-card shadow-sm">
                <div class="card-body">
                    <div class="text-muted small">Completed Hours</div>
                    <div class="display-6">@m_Data.TotalCompletedHours</div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card sp-card shadow-sm">
                <div class="card-body">
                    <div class="text-muted small">Completed Opportunities</div>
                    <div class="display-6">@m_Data.TotalCompletedCount</div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card sp-card shadow-sm">
                <div class="card-body">
                    <div class="text-muted small">Upcoming Signups</div>
                    <div class="display-6">@m_Data.UpcomingSignedUpCount</div>
                </div>
            </div>
        </div>
    </div>

    @* ===== Progress (HUD wrapper) ===== *@
    <div class="sp-progress-shell mb-3">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
                <div class="sp-label">Service Progress</div>
                <div class="sp-value">@ProgressText</div>
            </div>
            <div class="text-end">
                <span class="sp-progress-badge">@ProgressPercent%</span>
            </div>
        </div>

        <div class="progress mt-2" role="progressbar" aria-valuenow="@ProgressPercent" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar" style="width:@ProgressPercent%"></div>
        </div>
    </div>

    <h2 class="h5 mt-4">Available Opportunities</h2>

    @if (m_Available.Count == 0)
    {
        <div class="alert alert-secondary">
            No approved opportunities are currently available for you to sign up.
        </div>
    }
    else
    {
        @* ===== Table (HUD wrapper) ===== *@
        <div class="sp-table-shell mb-4">
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle">
                    <thead>
                        <tr>
                            <th style="width: 34%">Title</th>
                            <th style="width: 14%">Date</th>
                            <th style="width: 10%">Hours</th>
                            <th style="width: 26%">Contact</th>
                            <th style="width: 16%">City</th>
                            <th class="text-end" style="width: 10%">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var o in m_Available)
                        {
                            <tr>
                                <td class="fw-semibold">@o.Title</td>
                                <td>@o.Date.ToShortDateString()</td>
                                <td>@o.Hours</td>
                                <td>@o.Contact?.Name</td>
                                <td class="text-muted">@o.Contact?.Address?.City</td>
                                <td class="text-end text-nowrap">
                                    <button class="btn btn-sm btn-primary"
                                            disabled="@m_Busy"
                                            @onclick="() => Signup(o.Id)">
                                        Sign Up
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <div class="d-flex align-items-center justify-content-between mb-2">
        <h2 class="h5 mb-0">My Signups</h2>

        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" @onclick="Reload" disabled="@m_Busy">
                Refresh
            </button>
        </div>
    </div>

    @if (m_Data.MySignups.Count == 0)
    {
        <div class="alert alert-info">
            You don’t have any signups yet.
        </div>
    }
    else
    {
        @* ===== Table (HUD wrapper) ===== *@
        <div class="sp-table-shell">
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle">
                    <thead>
                        <tr>
                            <th style="width: 28%">Opportunity</th>
                            <th style="width: 14%">Date</th>
                            <th style="width: 10%">Hours</th>
                            <th style="width: 14%">Status</th>
                            <th style="width: 22%">Contact</th>
                            <th class="text-end" style="width: 12%">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var s in m_Data.MySignups)
                        {
                            var opp = s.VolunteerOpportunity;
                            <tr>
                                <td>
                                    <div class="fw-semibold">@opp.Title</div>
                                    @if (!string.IsNullOrWhiteSpace(opp.Description))
                                    {
                                        <div class="text-muted small text-truncate" style="max-width: 520px" title="@opp.Description">
                                            @opp.Description
                                        </div>
                                    }
                                </td>
                                <td>@opp.Date.ToShortDateString()</td>
                                <td>@opp.Hours</td>
                                <td>
                                    @if (s.IsCompleted)
                                    {
                                        <span class="badge bg-success">Completed</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Signed Up</span>
                                    }
                                </td>
                                <td>
                                    <div class="fw-semibold">@opp.Contact?.Name</div>
                                    <div class="text-muted small">
                                        @if (!string.IsNullOrWhiteSpace(opp.Contact?.Email))
                                        {
                                            <span>@opp.Contact!.Email</span>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(opp.Contact?.Phone))
                                        {
                                            <span>@(string.IsNullOrWhiteSpace(opp.Contact?.Email) ? "" : " • ")@opp.Contact!.Phone</span>
                                        }
                                    </div>
                                </td>
                                <td class="text-end text-nowrap">
                                    @if (!s.IsCompleted)
                                    {
                                        <button type="button"
                                                class="btn btn-sm btn-outline-success"
                                                disabled="@(m_Busy)"
                                                @onclick="() => MarkCompleted(s.Id)">
                                            Mark Completed
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">Done</span>
                                    }

                                    @{
                                        var isPast = s.VolunteerOpportunity.Date.Date < DateTime.Today;
                                        var canWithdraw = !isPast && !s.IsCompleted;
                                    }

                                    @if (canWithdraw)
                                    {
                                        <button class="btn btn-sm btn-outline-danger ms-1"
                                                disabled="@m_Busy"
                                                @onclick="() => ConfirmWithdraw(s.Id)">
                                            Withdraw
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-3 d-flex gap-2">
            <button class="btn btn-outline-secondary" @onclick="Print" disabled="@m_Busy">Print</button>
            <button class="btn btn-outline-secondary" @onclick="ExportCsv" disabled="@m_Busy">Export</button>
        </div>
    }
}

@code {
    [CascadingParameter] private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private DashboardService.DashboardData? m_Data;

    private bool m_Busy;
    private string? m_Error;
    private string? m_Status;

    private List<VolunteerOpportunity> m_Available = [];

    protected override async Task OnInitializedAsync()
    {
        m_RequiredHours = Config.GetValue<int>("CadetRequirements:RequiredHours");
        await Reload();
    }

    private async Task Reload()
    {
        try
        {
            m_Busy = true;
            m_Error = null;

            var auth = await (AuthenticationStateTask ?? throw new InvalidOperationException("No auth state."));
            var userId = auth.User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (string.IsNullOrWhiteSpace(userId))
            {
                m_Error = "Unable to determine current user.";
                return;
            }

            m_Data = await DashboardService.GetMyDashboardAsync(userId);
            m_Available = await OpportunityService.GetApprovedAvailableForUserAsync(userId);
        }
        catch (Exception ex)
        {
            m_Error = ex.Message;
        }
        finally
        {
            m_Busy = false;
        }
    }

    private async Task MarkCompleted(int signupId)
    {
        try
        {
            m_Busy = true;
            m_Error = null;
            m_Status = null;

            var auth = await (AuthenticationStateTask ?? throw new InvalidOperationException("No auth state."));
            var userId = auth.User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (string.IsNullOrWhiteSpace(userId))
            {
                m_Error = "Unable to determine current user.";
                return;
            }

            var (ok, err) = await DashboardService.MarkCompletedAsync(userId, signupId);
            if (!ok)
            {
                m_Error = err;
                return;
            }

            m_Status = "Completion submitted.";
            await Reload();
        }
        catch (Exception ex)
        {
            m_Error = ex.Message;
        }
        finally
        {
            m_Busy = false;
        }
    }

    private void Print() => Nav.NavigateTo("javascript:window.print()");

    private void ExportCsv()
    {
        m_Error = "Export not implemented yet.";
    }

    private async Task Signup(int opportunityId)
    {
        try
        {
            m_Busy = true;
            m_Error = null;

            var auth = await (AuthenticationStateTask ?? throw new InvalidOperationException("No auth state."));
            var userId = auth.User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (string.IsNullOrWhiteSpace(userId))
            {
                m_Error = "Unable to determine current user.";
                return;
            }

            var (ok, err) = await OpportunityService.SignupAsync(opportunityId, userId);
            if (!ok)
            {
                m_Error = err;
                return;
            }

            await Reload();
        }
        catch (Exception ex)
        {
            m_Error = ex.Message;
        }
        finally
        {
            m_Busy = false;
        }
    }

    private async Task ConfirmWithdraw(int signupId)
    {
        var ok = await JS.InvokeAsync<bool>("confirm", "Withdraw from this opportunity?");
        if (!ok) return;

        await Withdraw(signupId);
    }

    private async Task Withdraw(int signupId)
    {
        try
        {
            m_Busy = true;
            m_Error = null;
            m_Status = null;

            var auth = await (AuthenticationStateTask ?? throw new InvalidOperationException("No auth state."));
            var userId = auth.User.FindFirstValue(ClaimTypes.NameIdentifier);

            if (string.IsNullOrWhiteSpace(userId))
            {
                m_Error = "Unable to determine current user.";
                return;
            }

            var (ok, err) = await DashboardService.WithdrawAsync(userId, signupId);
            if (!ok)
            {
                m_Error = err;
                return;
            }

            m_Status = "Withdrawn.";
            await Reload();
        }
        catch (Exception ex)
        {
            m_Error = ex.Message;
        }
        finally
        {
            m_Busy = false;
        }
    }

    private int m_RequiredHours;

    private int ProgressPercent =>
        (m_Data is null || m_RequiredHours <= 0)
            ? 0
            : Math.Clamp((int)Math.Round(100.0 * m_Data.TotalCompletedHours / m_RequiredHours), 0, 100);

    private string ProgressText =>
        (m_Data is null || m_RequiredHours <= 0)
            ? $"{m_Data?.TotalCompletedHours ?? 0} hours"
            : $"{m_Data.TotalCompletedHours} / {m_RequiredHours} hours";
}
