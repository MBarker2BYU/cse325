@page "/Account/Manage/Emblem"
@rendermode InteractiveServer

@using ServePoint.Cadet.Extensions
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using ServePoint.Cadet.Data
@using ServePoint.Cadet.Models.Entities

@attribute [Authorize]

@inject DbGateway Db
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Manage your account - Emblem</PageTitle>

<h3 class="hud-title">Emblem</h3>

@if (!string.IsNullOrWhiteSpace(m_StatusMessage))
{
    <div class="alert alert-info">@m_StatusMessage</div>
}

<div class="sp-panel">
    <div class="sp-panel-header">
        <span class="hud-title">Choose your service emblem</span>
    </div>

    <div class="sp-panel-body">
        <div class="d-flex flex-column gap-3">

            <div class="d-flex align-items-center gap-3">
                <div style="width:150px;height:150px;display:flex;align-items:center;justify-content:center;border:1px solid var(--hud-border);border-radius:12px;background:rgba(0,0,0,.12);">
                    @if (!string.IsNullOrWhiteSpace(m_PreviewPath))
                    {
                        <img @key="m_PreviewPath"
                             src="@m_PreviewPath"
                             alt="@m_Selected.ToDisplay()"
                             style="width:150px;height:150px;object-fit:contain;" />
                    }
                    else
                    {
                        <span class="hud-muted-text" style="font-family:var(--mono);font-size:.85rem;">None</span>
                    }
                </div>

                <div class="flex-grow-1">
                    <label class="form-label" style="font-family:var(--mono);letter-spacing:.08em;text-transform:uppercase;">
                        Service emblem
                    </label>

                    <select class="form-select" aria-label="Select service emblem"
                            value="@m_Selected"
                            @onchange="OnSelectedChanged"
                            disabled="@(m_Saving || m_Loading)">
                        @foreach (var opt in m_Options)
                        {
                            <option value="@opt">@opt.ToDisplay()</option>
                        }
                    </select>

                    <div class="hud-muted-text mt-2" style="font-size:.85rem;">
                        This emblem is shown on your sidebar user card.
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" @onclick="SaveAsync" disabled="@(m_Saving || m_Loading)">
                    @(m_Saving ? "Saving..." : "Save")
                </button>

                <button type="button" class="btn btn-outline-secondary" @onclick="ReloadAsync" disabled="@(m_Saving || m_Loading)">
                    Reload
                </button>
            </div>

        </div>
    </div>
</div>

@code {
    private string? m_StatusMessage;

    private bool m_Loading;
    private bool m_Saving;

    private ServiceEmblem m_Selected = ServiceEmblem.None;
    private string? m_PreviewPath;

    private readonly ServiceEmblem[] m_Options = new[]
    {
        ServiceEmblem.None,
        ServiceEmblem.Usa,
        ServiceEmblem.Usn,
        ServiceEmblem.Usmc,
        ServiceEmblem.Usaf,
        ServiceEmblem.Ussf,
        ServiceEmblem.Uscg
    };

    protected override async Task OnInitializedAsync()
        => await LoadAsync();

    private static string? GetUserId(AuthenticationState auth)
        => auth.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value?.Trim();

    private async Task LoadAsync()
    {
        if (m_Loading) return;
        m_Loading = true;

        try
        {
            m_StatusMessage = null;

            var auth = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = GetUserId(auth);

            if (string.IsNullOrWhiteSpace(userId))
            {
                m_StatusMessage = "Unable to determine your user id.";
                m_Selected = ServiceEmblem.None;
                m_PreviewPath = m_Selected.ToImagePath();
                return;
            }

            var emblem = await Db.ExecuteAsync(async db =>
            {
                return await db.UserEmblems
                    .AsNoTracking()
                    .Where(x => x.UserId == userId)
                    .Select(x => (ServiceEmblem?)x.Emblem)
                    .FirstOrDefaultAsync();
            });

            m_Selected = emblem ?? ServiceEmblem.None;
            m_PreviewPath = m_Selected.ToImagePath();
        }
        finally
        {
            m_Loading = false;
        }
    }

    private void OnSelectedChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<ServiceEmblem>(e.Value?.ToString(), out var parsed))
            m_Selected = parsed;
        else
            m_Selected = ServiceEmblem.None;

        m_PreviewPath = m_Selected.ToImagePath();
    }

    private async Task SaveAsync()
    {
        if (m_Saving) return;
        m_Saving = true;
        m_StatusMessage = null;

        try
        {
            var auth = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = GetUserId(auth);

            if (string.IsNullOrWhiteSpace(userId))
            {
                m_StatusMessage = "Unable to determine your user id.";
                return;
            }

            await Db.ExecuteAsync(async db =>
            {
                var record = await db.UserEmblems
                    .FirstOrDefaultAsync(x => x.UserId == userId);

                if (record is null)
                {
                    db.UserEmblems.Add(new UserEmblem { UserId = userId, Emblem = m_Selected });
                }
                else
                {
                    record.Emblem = m_Selected;
                }

                await db.SaveChangesAsync();
            });

            m_PreviewPath = m_Selected.ToImagePath();
            m_StatusMessage = "Saved.";
        }
        catch (Exception ex)
        {
            m_StatusMessage = "Error saving emblem: " + ex.Message;
        }
        finally
        {
            m_Saving = false;
        }
    }

    private async Task ReloadAsync()
        => await LoadAsync();
}
